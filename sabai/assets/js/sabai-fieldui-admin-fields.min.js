(function(a){SABAI.FieldUI=SABAI.FieldUI||{};SABAI.FieldUI.adminFields=function(e){var e=a.extend({submitConfirm:"",leaveConfirm:"",deleteFieldConfirm:""},e),j=false,i,g,l=function(){var m=a(this);m.attr("data-modal-title",m.text());SABAI.ajax({type:"get",container:"#sabai-modal",url:this.href+(this.href.indexOf("?",0)===-1?"?":"&")+"field_type="+m.data("field-type")+"&field_name="+m.data("field-name"),onError:function(o,p,n){SABAI.flash(o.message,"danger")},onContent:function(n,p,o){p.focusFirstInput()},trigger:m,modalWidth:600});return false},b=function(){var p=a(this),o=a(this).closest(".sabai-fieldui-field"),n=o.find(".sabai-fieldui-field-id").attr("value"),m=o.attr("id");SABAI.ajax({type:"get",container:"#sabai-modal",url:this.href+(this.href.indexOf("?",0)===-1?"?":"&")+"ele_id="+m+"&field_id="+n,onContent:function(q,s,r){s.focusFirstInput()},onError:function(r,s,q){SABAI.flash(r.message,"danger")},trigger:p,modalWidth:600});h(o);return false},f=function(){var m=a(this).closest(".sabai-fieldui-field");h(m);if(!confirm(e.deleteFieldConfirm)){return false}if(m.find(".sabai-fieldui-field-id").attr("value")){i=setTimeout(function(){a("#sabai-fieldui").submit()},2000)}m.fadeTo("fast",0,function(){a(this).slideUp("medium",function(){a(this).remove()})});return false},d=function(o,m){if(!m.hide_label&&m.label){o.find("> .sabai-fieldui-field-label").html(m.required?m.label+'<span class="sabai-fieldui-field-required">*</span>':m.label).show()}else{o.find("> .sabai-fieldui-field-label").hide()}if(m.description){o.find("> .sabai-fieldui-field-description").html(m.description).show()}else{o.find("> .sabai-fieldui-field-description").hide()}var n=m.label+" - "+m.name;o.find("> .sabai-fieldui-field-preview").html(m.preview).end().find(".sabai-fieldui-field-title").text(n).end().find(".sabai-fieldui-field-edit").attr("data-modal-title",n).end().effect("highlight",{},2000)},h=function(m){k();m.addClass("sabai-fieldui-field-selected")},k=function(m){a("#sabai-fieldui").find(".sabai-fieldui-field-selected").removeClass("sabai-fieldui-field-selected")},c={axis:"y",items:".sabai-fieldui-field",handle:".sabai-fieldui-field-info",connectWith:"#sabai-fieldui-active .sabai-fieldui-fields",helper:"clone",opacity:0.8,cursor:"move",placeholder:"sabai-fieldui-field-placeholder",start:function(m,n){k();n.placeholder.width(n.helper.outerWidth()).height(n.helper.outerHeight());if(i){clearTimeout(i);i=null}},update:function(m,n){n.item.addClass("sabai-fieldui-moved");if(!i){i=setTimeout(function(){a("#sabai-fieldui").submit()},2000)}}};a(".sabai-fieldui-available").on("click",".sabai-fieldui-fields > a",l);a(".sabai-fieldui-field-control").on("click",".sabai-fieldui-field-edit",b).on("click",".sabai-fieldui-field-delete",f);a("#sabai-fieldui-active .sabai-fieldui-fields").sortable(c);a(".sabai-fieldui-available > .sabai-fieldui-title").click(function(){var n=a(this),m=n.closest(".sabai-fieldui-available").find(".sabai-fieldui-fields");if(m.is(":hidden")){m.slideDown("fast");n.find("a.sabai-fieldui-toggle i").removeClass("fa-caret-down").addClass("fa-caret-up")}else{m.slideUp("fast");n.find("a.sabai-fieldui-toggle i").removeClass("fa-caret-up").addClass("fa-caret-down")}return false});a("#sabai-fieldui").submit(function(){var m=a(this);k(true);j=true;SABAI.ajax({type:m.attr("method"),container:m,url:m.attr("action")+"&"+m.serialize(),onSuccess:function(n,o){o.find(".sabai-fieldui-moved").removeClass("sabai-fieldui-moved");a(SABAI).trigger("fieldui_fields_submitted.sabai",{result:n,target:o})},onError:function(o,p,n){SABAI.flash(o.message,"danger")},loadingImage:false});return false});window.onbeforeunload=function(){if(j){j=false;return}if(a("#sabai-fieldui").find(".sabai-fieldui-moved").length){return e.leaveConfirm}};g=a("#sabai-fieldui-available-wrap").offset();a(window).scroll(function(){if(a(window).scrollTop()>g.top-40){a("#sabai-fieldui-available-wrap").css({position:"fixed",top:"40px",left:g.left+"px"})}else{a("#sabai-fieldui-available-wrap").css("position","static")}});a(window).resize(function(){a("#sabai-fieldui-available-wrap").css("position","static");g.left=a("#sabai-fieldui-available-wrap").offset().left;if(a(window).scrollTop()>g.top-40){a("#sabai-fieldui-available-wrap").css({position:"fixed",top:"40px",left:g.left+"px"})}});a(SABAI).bind("fieldui_fields_submitted.sabai",function(r,q){if(!q.result.fields_existing){return}var p;for(p in q.result.fields_existing){var o=q.result.fields_existing[p];var m=a("#sabai-fieldui-existing-fields-"+o.type_normalized);if(!m.length){continue}var n=m.find('.sabai-fieldui-fields a[data-field-name="'+o.name+'"]');if(!n.length){continue}if(!m.is(":visible")){m.fadeIn(100,function(){n.fadeIn(300)})}else{n.fadeIn(300)}}});a(SABAI).bind("fieldui_field_created.sabai",function(s,q){q.target.hide();var n=a("#sabai-fieldui-active").find(".sabai-fieldui-fields").first();if(!n.length){return}var r=a("#sabai-fieldui-field").clone(true).attr("id","sabai-fieldui-field"+q.result.id).data("field-type",q.result.type).data("field-type-normalized",q.result.type_normalized).data("field-name",q.result.name).addClass(q.result.field_system?"sabai-fieldui-core-field":"sabai-fieldui-custom-field").addClass("sabai-fieldui-field-type-"+q.result.type_normalized).find(".sabai-fieldui-field-id").attr("value",q.result.id).end().find(".sabai-fieldui-field-help").remove().end().appendTo(n).show();SABAI.scrollTo(r);d(r,q.result);a("#sabai-fieldui").submit();h(r);var m=a("#sabai-fieldui-existing-fields-"+q.result.type_normalized),p=m.find(".sabai-fieldui-fields a").filter(":visible").length,o=m.find('.sabai-fieldui-fields a[data-field-name="'+q.result.name+'"]');if(o.length){o.fadeOut(300);if(p===1){m.fadeOut(300)}}});a(SABAI).bind("fieldui_field_updated.sabai",function(o,m){m.target.hide();var n=a("#"+m.result.ele_id);SABAI.scrollTo(n);d(n,m.result)})}})(jQuery);